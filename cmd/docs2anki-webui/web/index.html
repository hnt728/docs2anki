<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>docs2anki</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <main class="page">
    <section class="hero card">
      <h1>docs2anki</h1>
      <p>PDF/画像をGeminiで一問一答カード化し、画面上で修正してCSV出力できます。</p>
    </section>

    <section class="split-layout">
      <section class="card">
        <h2>生成設定</h2>
        <form id="job-form" class="grid">
          <label>
            <span>Gemini API Key</span>
            <input type="password" name="apiKey" placeholder="空欄なら環境変数を使用" />
          </label>
          <label>
            <span>Model</span>
            <input type="text" name="model" value="gemini-3-flash-preview" />
          </label>
          <label class="full">
            <span>入力ファイル（PDF / 画像）</span>
            <input type="file" name="source" accept="application/pdf,image/png,image/jpeg,image/webp,image/gif,image/bmp,image/tiff" multiple required />
          </label>
          <label>
            <span class="label-with-help">ページ範囲 <button type="button" class="help-btn" data-help-key="ranges" aria-label="ページ範囲の説明を表示" title="ページ範囲の説明">?</button></span>
            <input type="text" name="ranges" value="1-10" required />
          </label>
          <label>
            <span class="label-with-help">Step <button type="button" class="help-btn" data-help-key="step" aria-label="Stepの説明を表示" title="Stepの説明">?</button></span>
            <input type="number" name="step" value="1" min="1" />
          </label>
          <label>
            <span class="label-with-help">Overlap <button type="button" class="help-btn" data-help-key="overlap" aria-label="Overlapの説明を表示" title="Overlapの説明">?</button></span>
            <input type="number" name="overlap" value="0" min="0" />
          </label>
          <label>
            <span class="label-with-help">Min Confidence <button type="button" class="help-btn" data-help-key="minConfidence" aria-label="Min Confidenceの説明を表示" title="Min Confidenceの説明">?</button></span>
            <input type="number" name="minConfidence" value="0.7" min="0" max="1" step="0.05" />
          </label>
          <label>
            <span class="label-with-help">Concurrency <button type="button" class="help-btn" data-help-key="concurrency" aria-label="Concurrencyの説明を表示" title="Concurrencyの説明">?</button></span>
            <input type="number" name="concurrency" value="1" min="1" />
          </label>
          <label>
            <span class="label-with-help">Delay(ms) <button type="button" class="help-btn" data-help-key="delayMs" aria-label="Delayの説明を表示" title="Delayの説明">?</button></span>
            <input type="number" name="delayMs" value="0" min="0" />
          </label>
          <label>
            <span class="label-with-help">Retries <button type="button" class="help-btn" data-help-key="retries" aria-label="Retriesの説明を表示" title="Retriesの説明">?</button></span>
            <input type="number" name="retries" value="2" min="0" />
          </label>
          <label>
            <span class="label-with-help">Thinking Budget <button type="button" class="help-btn" data-help-key="thinkingBudget" aria-label="Thinking Budgetの説明を表示" title="Thinking Budgetの説明">?</button></span>
            <input type="number" name="thinkingBudget" value="0" min="-1" />
          </label>
          <label class="full">
            <span>Front生成指示</span>
            <input type="text" name="frontPrompt" value="本文の要点から短い質問を作る" />
          </label>
          <label class="full">
            <span>Back生成指示</span>
            <input type="text" name="backPrompt" value="質問に対する簡潔な答えを1-3文で" />
          </label>
          <div class="full actions">
            <button type="submit" id="start-btn">生成開始</button>
          </div>
        </form>
      </section>

      <section class="card preview-card" id="preview-card">
        <div class="preview-head">
          <h2>ファイルプレビュー</h2>
          <button type="button" id="preview-toggle" class="icon-btn" aria-expanded="true" aria-controls="preview-body" title="プレビューを折りたたむ">
            <span class="arrow">▾</span>
          </button>
        </div>

        <div id="preview-body" class="preview-body">
          <p class="preview-note">PDF/画像ともにページ範囲 / step / overlap に応じてチャンクプレビューを表示します（画像のページ=画像の並び順）。</p>
          <div id="preview-error" class="preview-error" hidden></div>

          <div class="preview-controls">
            <button type="button" id="page-prev" class="small-btn">← 前へ</button>
            <span id="page-indicator">page -</span>
            <button type="button" id="page-next" class="small-btn">次へ →</button>
          </div>

          <div id="preview-frame-wrap" class="preview-frame-wrap">
            <canvas id="pdf-preview-canvas"></canvas>
            <img id="image-preview" alt="画像プレビュー" hidden />
            <div id="preview-empty" class="preview-empty">ファイルを選択するとここにプレビューが表示されます</div>
          </div>

          <div class="chunk-head">
            <strong>チャンク一覧</strong>
            <span id="chunk-summary">0件</span>
          </div>
          <div id="chunk-list" class="chunk-list"></div>
        </div>
      </section>
    </section>

    <section class="card" id="progress-card">
      <h2>進捗</h2>
      <div class="progress-row">
        <div class="bar"><div class="bar-fill" id="bar-fill"></div></div>
        <div id="progress-text">待機中</div>
      </div>
      <div id="status-message" class="status"></div>
      <div id="status-detail-box" class="status-detail-box" hidden>
        <div class="status-detail-title">詳細</div>
        <pre id="status-detail" class="status-detail"></pre>
      </div>
      <div id="active-chunks" class="chips"></div>
    </section>

    <section class="card" id="result-card" hidden>
      <div class="result-head">
        <h2>カード確認・修正</h2>
        <div class="toolbar">
          <input type="search" id="search" placeholder="検索（問題・解答・page）" />
          <label class="inline-check"><input type="checkbox" id="only-issues" /> issueのみ</label>
          <button type="button" id="add-row">行を追加</button>
          <button type="button" id="export-csv">CSVエクスポート</button>
          <button type="button" id="export-json">JSONエクスポート</button>
        </div>
      </div>
      <div id="summary" class="summary"></div>
      <div class="table-wrap">
        <table id="cards-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Page</th>
              <th>Question</th>
              <th>Answer</th>
              <th>Confidence</th>
              <th>Issue</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
  <script src="/static/app.js" defer></script>
</body>
</html>
